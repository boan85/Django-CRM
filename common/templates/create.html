{% extends 'base.html' %}
{% load staticfiles %}
{% block breadcrumb %}
    <link href="{% static 'css/main.scss' %}" rel="stylesheet"/>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            {% if request.user != user_obj %}
                <li class="breadcrumb-item"><a href="{% url 'common:users_list' %}"><div class="links_and_buttons">Users</div></a></li>
                <li class="breadcrumb-item" style="color: ghostwhite">{% if user_obj %}Edit{% else %}Create{% endif %}</li>
            {% endif %}
        </ol>
    </nav>
{% endblock breadcrumb %}
{% block content %}
    <form id="add_form" method="POST" action="" novalidate>
        <div class="overview_form_block row marl justify-content-center">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-body crm-table">
                        <div class="my-table-color my-table-title-bg">
                            {% if user_obj %}EDIT{% else %}CREATE{% endif %} USER
                        </div>
                        <div class="row marl">
                            <div class="filter_col col-md-4">
                                <div class="form-group">
                                    <label for="id_firstname"><div class="my-label-color">First Name{% if user_form.first_name.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    <input type="text" class="form-control" name="first_name" value="
                                            {% if user_obj %}{{ user_obj.first_name }}{% else %}{{ request.POST.first_name }}{% endif %}">
                                </div>
                                <span class="error" id="id_first_name">{{ errors.first_name }}</span>
                            </div>
                            <div class="filter_col col-md-4">
                                <div class="form-group">
                                    <label for="id_lastname"><div class="my-label-color">Last Name{% if user_form.last_name.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    <input type="text" class="form-control" name="last_name" value="
                                            {% if user_obj %}{{ user_obj.last_name }}{% else %}{{ request.POST.last_name }}{% endif %}"
                                           placeholder="Last Name">
                                </div>
                                <span class="error" id="id_last_name">{{ errors.last_name }}</span>
                            </div>
                            <div class="filter_col col-md-4">
                                <div class="form-group">
                                    <label for="id_username"><div class="my-label-color">Username{% if user_form.username.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    <input type="text" class="form-control" name="username" value="
                                            {% if user_obj %}{{ user_obj.username }}{% else %}{{ request.POST.username }}{% endif %}"
                                           placeholder="Username">
                                </div>
                                <span class="error" id="id_username">{{ errors.username }}</span>
                            </div>
                            <div class="filter_col col-md-6" {% if user_obj %} style="display: none;" {% endif %}>
                                <div class="form-group">
                                    <label for="id_email"><div class="my-label-color">Email Address{% if user_form.email.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    <input type="text" class="form-control" name="email" value="
                                            {% if user_obj %}{{ user_obj.email }}{% else %}{{ request.POST.email }}{% endif %}"
                                            {% if user_obj %} readonly=""{% endif %} placeholder="Email">
                                </div>
                                <span class="error" id="id_email">{{ errors.email }}</span>
                            </div>
                            <div class="filter_col col-md-6"
                                 {% if request.user.role != 'ADMIN' and not request.user.is_superuser or request.user.id == user_obj.id %}style="display:none;"{% endif %}>
                                <div class="form-group">
                                    <label for="id_role"><div class="my-label-color">User Role{% if user_form.role.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    {% if request.user.role == 'ADMIN' or request.user.is_superuser %}
                                        <select name="role" class="form-control">
                                            {% for key, value in form.role.field.choices %}
                                                <option value="{{ key }}"
                                                        {% if value == user_obj.role %}selected="selected"
                                                        {% elif user_obj.is_superuser and value == "ADMIN" %}selected{% endif %}>{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                    {% else %}
                                        <select name="role">
                                            <option value="{{ user_obj.role }}">{{ user_obj.role }}</option>
                                        </select>
                                    {% endif %}
                                    <span class="error" id="id_role">{{ user_form.role.errors }}</span>
                                </div>
                            </div>
                            <div class="filter_col col-md-6">
                                <div class="form-group">
                                    <label for="exampleInputEmail1"><div class="my-label-color">Password{% if user_form.password.field.required %}
                                        <span class="error">*</span>{% endif %}</div></label>
                                    <input type="password" class="form-control" name="password"
                                           value="{{ request.POST.password }}" placeholder="Password">
                                </div>
                                <span class="error" id="id_password">{{ errors.password }}</span>
                            </div>
                            <div class="filter_col col-md-6">
                                <div class="form-group">
                                    <label for="exampleInputEmail1"><div class="my-label-color">Upload Profile Picture
                                        {% if user_form.profile_pic.field.required %}
                                            <span class="error">*</span>{% endif %}</div></label>
                                    <input type="file" name="profile_pic" accept="image/*" class="form-control button"/>
                                </div>
                                {% if user_obj %}<span>{{ user_obj.profile_pic }}</span>{% endif %}
                                <span class="error" id="id_profile_pic">{{ errors.profile_pic }}</span>
                            </div>
                        </div>
                    </div>
                    <p style="color:red" id="forbiden_error"></p>
                    <div class="row marl buttons_row form_btn_row text-center">
                        <button class="btn my-button-save" type="submit">Save</button>
                        <a href="
                                {% if not user_obj or request.user.is_superuser or request.user.role == 'ADMIN' %}{% url 'common:users_list' %}{% else %}{% url 'common:profile' %}{% endif %}">
                            <button class="btn my-button-cancel" id="create_user_cancel">Cancel</button></a>
                    </div>
                </div>
            </div>
        </div>
    </form>
{% endblock content %}
{% block js_block %}
    <script src="https://malsup.github.io/jquery.form.js"></script>
    <script type="text/javascript">
        $('form#add_form').ajaxForm({
            type: 'POST',
            dataType: 'json',
            url: ".",
            data: $('#add_form').serialize(),
            success: function (data) {
                if (data.error) {
                    if (data.error_403) {
                        $("#forbiden_error").text(" *You Don't have permission to edit this user ");
                    }
                    if (data.errors) {
                        $('.error').html('')
                        for (var key in data.errors) {
                            $('#id_' + key).html("<p>" + data.errors[key][0] + "</p>");
                        }
                        ;
                    }
                }
                else {
                    window.location = data.success_url;
                }
            }
        });
    </script>
{% endblock js_block %}

<style>
input[placeholder]          {color:ghostwhite;}
input::-moz-placeholder     {color:ghostwhite;}
input:-moz-placeholder      {color:ghostwhite;}
input:-ms-input-placeholder {color:ghostwhite;}
</style>